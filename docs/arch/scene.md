# 场景分析
## 库存
场景1：商家设置库存：写入mysql
场景2：下单减库存

这里主要考虑用户场景，采用拍减库存，下单就减库存（mq异步减库存），

为了防止超售，采用以下方案：
先同步减库存，后异步记录库存变更流水，保证减库存仅一次同步的MySQL操作。
利用流水表唯一键（订单ID + 商品ID + 退货序号），保证同一订单减库存、同一订单同一商品部分退货的幂等性。
通过对库存变更流水校验/回滚机制保证库存表与流水表的最终一致性，避免使用数据库事务。
与订单系统约定异常处理规则，如：订单遇减库存超时，则下单失败，且需异步调恢复库存。


最终一致性的防超售
原子性：lua脚本
  前置防重
  扣减库存
  库存流水（AOF同步流水到mysql -- 此时在rebalance的时候可能丢失，通过MQ消息冗余备份）
  
最终一致性：流水校验
高性能：Redis同步扣减，异步发送MQ记录流水

提交订单：同步减库存
订单异常，订单取消：异步回滚库存

业务：

redis-> 批量同步mysql -> cella写入缓存

DTS的修复方案（frog）



秒杀：
redis
lua  快，事务性


## 抢红包



