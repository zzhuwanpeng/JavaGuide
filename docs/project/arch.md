## 业务介绍
1. 采集音频来源：主播上传，广播，直播，抓取；转码入库；主播站，媒资系统
2. 用户收听：app，车载，第三方api调用
3. 业务：收听，直播，付费，积分，开放运营，智能电台。

## 数据量
3000音频，用户量300万，日活用户30万。TPS：2万次左右，均值1万

## 我主导进行了三方面的架构设计：
1. 智能电台
   千人千面，通过内存，redis等提高性能
   通过akka系统进一步解决播单的并发下顺序性问题，采用邮箱接口；分布式调用管理任务系统
2. CQRS
   解决读写分离，数据不一致的问题
   采用cannal作为数据同步手段，然后  
3. 基于TOB的复杂业务，采用栏目组+运营位+使用范围的模式，解决了多厂家展示，不同端展示的需求；
   原有设计按页面进行开发，迭代太慢，同一个音频在不同配置下无法解决试用范围的问题。
   涉及风控，源控制，时段展示，头图等各个方面；并形成开放平台。车场可以直接对接。



##
业务概念：
栏目，分类 （适用范围）
专辑，直播，电台，广播
碎片
标签，风控标签，付费信息：风控，主播，用户信息

流程：
手机，车载，k-radio，openapi，小程序
主播上传，媒资上传
付费，审核
智能电台（品牌电台）：台宣，碎片，广播，直播，时效电台，权重电台
直播，广播
灵活配置运营位



#  数据同步-cannal
原因:  对于风控的专辑，有时候会存在缓存，数据库不一致的问题，通过cannal来解决。

databus: 同步分片(线程)来提高性能，每行一个id用于分片，按行保证顺序性（可以不按binlog顺序）



## cannal
Server端获取binlog，封装成CannalMessage,里面是对应的Entry
Client **订阅**消息，在代码中处理关心的id，并发的进行处理
通过zk完成高可用，消费记录也记录在offset端。

多线程下的顺序性：
先确保每个client只能分配到固定的ID，（或者直接按库表分）
机器内部有一个阻塞队列记录了各个批次号：LinkedBlockingQueue<Long> batchIds，这样批次号必须顺序消费

幂等性：insert重复更新es

使用ES的原因：


## 智能电台
使用akka的原因：
- 专辑下架，主播上传视频，电台clock变更，集中在某个时间点同时更新，且需要刷新几百个电台，需要高性能，同时能帮我们解决并发的问题
- 保证消息的顺序性，akka天然的邮箱
- 搭建方便，容易扩展的分布式集群

- 优化点：推拉结合，双播单解决整点问题

1. 每个电台有自己的编排，编排按clock切换，如早中晚，节假日时段。同一编排内有不同的轮次，每个轮次按编排位形成不同的节目
编排位有不同的类型，如台宣，个推位，直播，普通音频节目等，一般节目可以从分类或标签维度，车型，地域等维度取出，可以按专辑的分值，上线时间一轮轮的取出。
2. 以上形成了公共播单，根据去重，个性化推荐形成个人播单
3. 难点在于：每次更新碎片或者专辑，标签等刷新计算量非常大，一次更新需要多台机器。

akka：
+ 解决了并发顺序性的问题，比如多个音频同时更新播单，在多线程的环境容易错乱，使用actor可以避免这样的问题，同时基于邮箱可以归并一些无效的更新（自定义邮箱）  
+ 任务管理，容错
+ akka的高并发的性能，异步非阻塞


+ http -> nginx -> flume -> rocketmq -> storm -> redis   接收收听历史，存入redis




### dts,TODO
如何保证顺序？-设置分片字段，相同的值在一个线程中处理

DTS原理分析-如何在并发前提下保证顺序

这里的顺序性非严格顺序性： DTS发送的事件是否严格按照Binlog的事件来进行发送的？

不是的。DTS保证行级别有序。具体是指DTS要求接入时对一个表指定的分片字段，相同的分片字段值的binlog事件会进入相同的分片（内部线程），所以是行级有序的。具体原理请参考Databus如何保证顺序性&一致性

需要注意的是：

1）DTS分片字段和下游mq的分区字段保持一致

2）DTS事务内的事件按表粒度逐表发送，并非完全按照提交事务的事件顺序发送

3）DTS无法保证来自不同数据流的事件之间的顺序性

事务发送

DTS暂时还不支持事务发送（databus没有限流和事务大小控制，大事务场景会出现DB慢sq以及数据流延迟的问题。）

Databus的事务发送是将事务打散到每个分片后，在分片内将同一个事务的变更缓存到一个List里，事务commit后每个分片各自将List内的数据一次性发送给业务

Thrift消费方式的业务会在handleTransaction(List<Event> eventList)的回调里收到一批变更，Mafka消费方式的业务会收到一个JsonArray的消息






