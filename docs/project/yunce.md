
## 云测项目：

### 架构
#### 云测架构
+ portal，shortlink-api
+ slave，MCD流水线
   + workers，不同的测试项
+ slave，环境
+ DC
+ sdk，conan-tools

#### 云真机架构
+ Agent
   + provider消息处理分发，负责手机状态的管理和初始化
   + device模块，负责各个消息的处理，手机各个服务管理
     + 各个plugin，包括shell，性能观测，minitouch，minicap,log,截图，安装
   + Andorid： adbkit,minitouch,minicap,agent-server,用于和手机通信
   + iOS ： iproxy，wda
   + 提供的websocket模块

+ Triproxy 
  + 独立拆分   
  + 三向代理，因为web层和agent层是多对多的关系，都需要pub-sub
  + 改为无状态，做到的扩展
 
+ web层
  + websocket，租借展示
  + 设备，用户相关通能
  + 数据库
  + 云测通信
 
+ 使用zmq的原因：
  - 即时通信
  - zmq的消息通信机制灵活
    - 向上设备消息，通过广播通知到web层各个机器
    - 向下，用户操作通过triproxy，到provider进程，在分发到各个设备的线程
   

### 自动化原理
Android:
DC: adbkit 负责连接adbserver，并暴露湍口，
slave ：启动appiumserver，连接到暴露的ip+port

iOS:
DC:   xcode负责编译wda到手机，
对于短链路,appiumserver安装在DC上，iproxy转发appium（wda）的端口
对于云测：
对于slave，appiumserver安装在VM上，iproxy转发wda的端口
DC：socat转发，通过uui确定唯一设备

socat: 相当于直连，用于远程调试
    
 

### 难点
+ 环境不稳定
  +用户执行的层面不可控，服务内部状态难以管理 -- 拆分appium，adb，录屏等工具；领导希望增加容器化的研发测试工具
+ 技术庞杂
+ 每个设备需要启动非常多的服务，手机接线不稳定，造成各种服务端口等的状态不一致，
   + 防抖动，延迟100ms处理，
   + context封装，启动时销毁
   + 快速启动，拆分线程处理不同的服务
+ 与云测结合，建立同步机制，业务的限制，使用强同步，出错采用重试机制；
  加入云测自动化后，存在大量失败任务，内存和手机（内存释放，手机还在跑任务），外部数据库存在状态一致性问题
  + 双向强同步，先落库，保证其他人无法占用，zmq消息，保证消息不丢失，同时同步到前端，其他用户查询需要强制校验。
  + 在云测端保持一个任务状态，和一个占用状态，全部操作通过事务保证两者一直，从而确保手机内存的占用和手机的任务状态是一致的。
    
+ 任务排队机制
   + 建立任务快照，局部排队最优
   + 分布式锁占用任务

### 我的工作
   + 云测环境拆分
   + 开放测试能力，提供组件方式
     + 在原有开放api的基础上提供了组件能能力
   + 融合云测和云真机，稳定性改造
   + 功能迭代
   + 测试项建设：性能测试，弱网测试
   
### 数据
手机  1500台 + 300台模拟器 + 自有业务手机
并发量 1000+的自动化任务




=====================================================一下待合并========
门户：
   -- 接收任务，case（SDK）
   -- 资源配置：占用设备，占用环境
   -- 设备，任务管理
   -- 运维大盘
   -- 报告输出

流水线接入(Main服务)
   
执行机（slave）：（VM）
   运行case

容器环境：（重构：分离依赖，分离负载）
   设置adb，appium，ffmpeg，python，弱网环境等
   iOS -  VM  (WDA)
   
设备资源层:设备管理服务（融合Phone-agent）
   adbkit
   模拟器

## 测试项
   弱网测试，性能测试，功能自动化，稳定性，兼容性，UI兼容性测试

## 难点
测试领域的任务调度，专业性强
1. 拆分任务调度，型号，usefor两个字段，系统版本三个维度）较多的手机，（线性规划的算法，启发式算法？）  手机资源具有独占性
   portal内调度组件，获取任务的时间窗口，计算局部最优解  
3. 设备资源管理：设备状态一致性
3. 云真机实时画面
   使用技术较丰富，依赖移动端，服务端，实时性，前端，nodejs
   协议： usb通过adbkit转为tcp，通过websocket展示在前端
   zmq：分层设计，拆分了设备管理，节点管理，消息交互，消息处理（与数据库交互），websocket界面交互等逻辑
   zmq的特点：
      1. 快，方便的网络通信工具
      2. dealer：双向通信，且消息只被处理一次
         push，pull保证消息不丢
         pub，sub发布订阅
   租借协议：
5. Log使用了ES进行存储。

技术：

使用了Nodejs 

天然异步非阻塞，所有的库都是异步非阻塞的，可以链式调用，而java实现起来比较困难
Nodejs事件驱动，循环的取出事件,如果有事件就取出，然后执行事件的回调函数
异步非阻塞：异步是用户层面的（编码时，执行和结果分离），非阻塞是操作系统层面的，api支持非阻塞而不是系统需要挂起。

使用zmq

内存中不丢消息，消息相对可靠，至少一次deliver
支持多种协议，云真机是租借系统，订阅模式等比较适合


## ones
-- 领域划分
需求子域，项目子域，研发子域，测试子域，元数据子域（定于字段，视图，工作流状态等）



### 一般的电商领域划分：
商品管理（Product Management）：包括商品的上架、分类、属性、价格等管理。
订单处理（Order Processing）：包括订单的创建、修改、支付、状态跟踪等。
客户管理（Customer Management）：涉及用户的注册、登录、个人信息管理、会员等级等。
物流管理（Logistics Management）：包括配送方式、物流跟踪、库存管理等。
支付处理（Payment Processing）：支付方式的集成、交易的处理和安全等。
支撑域可能包括：

用户评价（Review Management）：用户对商品的评价和反馈。
营销活动（Marketing and Promotions）：促销活动、优惠券、积分等营销工具。
客户服务（Customer Service）：售后服务、用户咨询、投诉处理等。
内容管理（Content Management）：网站内容、广告、新闻稿等内容的管理。
数据分析（Data Analysis）：对用户行为、交易数据等进行分析，以支持决策。


